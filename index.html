<!DOCTYPE html>
<html lang="zh-CN">

<!--
    Copyright (c) HikiMuæ…•é±¼é…± All rights reserved.
    Version: 25.11.02 (githubç‰ˆæœ¬ 1.3)
    -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µæ± å®¹é‡è®¡ç®—å™¨</title>
    <meta name="description" content="ç”µæ± å®¹é‡è®¡ç®—å™¨æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œç”¨äºä»å¯¼å‡ºçš„ZIPæ–‡ä»¶ä¸­æå–ç”µæ± å®¹é‡ä¿¡æ¯ï¼Œå¹¶è®¡ç®—å½“å‰ç”µæ± å®¹é‡çš„ç™¾åˆ†æ¯”">
    <meta name="keywords" content="ç”µæ± å®¹é‡è®¡ç®—å™¨, è¯Šæ–­æ–‡ä»¶å¤„ç†, ç”µæ± å¥åº·åº¦, ç”µæ± å®¹é‡ç™¾åˆ†æ¯”, zip.jsåº“, HyperOSç”µæ± å®¹é‡, MIUIç”µæ± å®¹é‡, ç”µæ± å®¹é‡æå–å·¥å…·, ç”µæ± å¥åº·åº¦æ£€æµ‹">
    <script src="js/zip.min.js"></script>
    <style>
        body {
            font-family: 'Arial', 'sans-serif', 'Misans';
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
            color: #2d3748;
        }

        .container {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }

        h1 {
            color: #2b6cb0;
            text-align: center;
            margin-bottom: 25px;
            font-weight: 600;
            font-size: 28px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .instructions {
            margin-bottom: 25px;
            padding: 18px;
            background: linear-gradient(135deg, #ebf8ff 0%, #e6fffa 100%);
            border-radius: 8px;
            border-left: 5px solid #4299e1;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        }

        .file-upload {
            margin-bottom: 25px;
        }

        .file-upload input {
            display: block;
            width: 95%;
            padding: 14px;
            margin-top: 8px;
            border: 2px dashed #cbd5e0;
            border-radius: 6px;
            background-color: #f7fafc;
            transition: all 0.3s ease;
        }

        .file-upload input:hover {
            border-color: #4299e1;
            background-color: #edf2f7;
        }

        .input-group {
            margin-bottom: 25px;
            transition: all 0.3s ease;
            display: none;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2d3748;
            font-size: 15px;
        }

        .input-group input {
            width: 100%;
            padding: 14px;
            box-sizing: border-box;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            background-color: #ffffff;
            transition: all 0.3s ease;
            font-size: 15px;
        }

        .input-group input:focus {
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
            outline: none;
        }

        button {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(72, 187, 120, 0.2);
        }

        button:hover {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            box-shadow: 0 4px 8px rgba(72, 187, 120, 0.3);
            transform: translateY(-1px);
        }

        .status {
            margin-top: 20px;
            padding: 16px;
            background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
            border-radius: 8px;
            display: none;
            border-left: 5px solid #4299e1;
            color: #2d3748;
            font-weight: 500;
        }

        .result {
            margin-top: 25px;
            padding: 20px;
            border-radius: 8px;
            display: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .success {
            background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%);
            color: #22543d;
            border-left: 5px solid #48bb78;
        }

        .error {
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
            color: #742a2a;
            border-left: 5px solid #f56565;
        }

        .result-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .result-content {
            margin-bottom: 18px;
        }

        .result-content pre {
            background-color: #f7fafc;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Cascadia Code', 'Courier New', monospace;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            border: 1px solid #e2e8f0;
        }

        .toggle-btn {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 12px;
            display: inline-block;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(66, 153, 225, 0.2);
        }

        .toggle-btn:hover {
            background: linear-gradient(135deg, #3182ce 0%, #2b6cb0 100%);
            box-shadow: 0 4px 8px rgba(66, 153, 225, 0.3);
            transform: translateY(-1px);
        }

        .original-text {
            display: none;
            margin-top: 12px;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 8px;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            border: 1px solid #e2e8f0;
            font-family: 'Cascadia Code', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: #334155;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            max-height: 500px;
            overflow-y: auto;
            tab-size: 4;
            -moz-tab-size: 4;
        }

        .original-text .battery-key {
            color: #dc2626;
            font-weight: 600;
            background-color: #fef2f2;
            padding: 1px 4px;
            border-radius: 3px;
        }

        .original-text .capacity-value {
            color: #059669;
            font-weight: 600;
            background-color: #f0fdf4;
            padding: 1px 4px;
            border-radius: 3px;
        }

        .original-text .time-value {
            color: #7c3aed;
            font-weight: 500;
            background-color: #faf5ff;
            padding: 1px 4px;
            border-radius: 3px;
        }

        .original-text .section-title {
            text-align: left;
            font-weight: 700;
            font-size: 15px;
            color: #1e293b;
            margin: 20px 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
            font-family: 'Arial', 'sans-serif', 'Misans';
        }

        .original-text .section-title:first-child {
            margin-top: 0;
        }

        .original-text .content-block {
            margin-bottom: 20px;
            text-align: left;
        }

        .original-text .content-block pre {
            text-align: left;
            margin: 0;
            padding: 0;
            background: transparent;
            border: none;
            font-family: 'Cascadia Code', 'Courier New', monospace;
        }

        .original-text::-webkit-scrollbar {
            width: 8px;
        }

        .original-text::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .original-text::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .original-text::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .footer {
            text-align: center;
            margin-top: 25px;
            font-size: 14px;
            color: #718096;
        }

        .footer a {
            color: #4299e1;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .footer a:hover {
            color: #3182ce;
            text-decoration: underline;
        }

        .open-source-links {
            margin-top: 12px;
            display: flex;
            justify-content: center;
            gap: 12px;
        }

        .open-source-links span {
            color: #a0aec0;
        }

        .open-source-links a {
            color: #4a5568;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
            font-family: 'Cascadia Code', 'Arial', sans-serif;
        }

        .open-source-links a:hover {
            color: #2d3748;
            text-decoration: underline;
        }

        .media-alert {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #fffaf0 0%, #feebc8 100%);
            border-radius: 8px;
            border-left: 5px solid #ed8936;
        }

        .media-alert h2 {
            color: #744210;
            margin-bottom: 12px;
        }

        .media-alert p {
            color: #744210;
            line-height: 1.6;
        }

        .media-highlight {
            background-color: #fed7d7;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }

        code,
        .english-text {
            font-family: 'Cascadia Code', 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        #calculate-btn {
            display: none;
        }
    </style>
</head>

<body>
    <div id="watermark-container"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden;">
    </div>
    <div class="container">
        <h1>å°ç±³ç”µæ± å®¹é‡è®¡ç®—å™¨</h1>

        <div class="instructions">
            <p><strong>å…³äºæœ¬å·¥å…·ï¼š</strong> æå–è¯Šæ–­æ–‡ä»¶ä¸­çš„ç”µæ± æ•°æ®ï¼Œå¹¶è®¡ç®—å½“å‰å®¹é‡ç™¾åˆ†æ¯”ã€‚</p>
            <p><strong>ä½¿ç”¨è¯´æ˜ï¼š</strong> è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼Œä»¥è·å–å‡†ç¡®çš„ç”µæ± å®¹é‡ç™¾åˆ†æ¯”ã€‚</p>
            <p><strong style="color:red">âš ï¸æ³¨æ„: æ‰€æœ‰åˆ†æè¿‡ç¨‹å‡åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°å®Œæˆï¼Œæ•°æ®ä¸ä¼šä¸Šä¼ è‡³ä»»ä½•æœåŠ¡å™¨ï¼Œç¡®ä¿æ‚¨çš„ä¿¡æ¯å®‰å…¨</strong></p>
            <p><strong style="color:red">âš ï¸å…è´£å£°æ˜: è‹¥è®¾å¤‡å‡ºç°å¼‚å¸¸ï¼Œè¯·å‰å¾€å°ç±³å®˜æ–¹å”®åã€‚<br>æœ¬å·¥å…·ä»…é€šè¿‡è§£æç³»ç»Ÿè¯Šæ–­æ–‡ä»¶ä¼°ç®—ç”µæ± å®¹é‡ï¼Œç»“æœä»…ä¾›å‚è€ƒï¼Œä¸å…·å¤‡å®˜æ–¹æ£€æµ‹æ•ˆåŠ›ã€‚</strong>
            </p>
        </div>

        <div class="instructions">
            <p>æ®è¯´å…ˆæŠŠç”µé‡å……åˆ° 100% å†ç»§ç»­å…… 30 åˆ†é’Ÿæ›´å‡†ä¸€äº›å“¦~</p>
            <p><strong>æ­¥éª¤ 1ï¼š </strong>è¯·è¿ç»­ç‚¹å‡»"è®¾ç½® > å…¨éƒ¨å‚æ•°ä¸ä¿¡æ¯ > å¤„ç†å™¨(è¿ç»­ç‚¹å‡»)"</p>
            <p><strong>æˆ–ï¼š </strong>è¿ç»­æŒ‰éŸ³é‡åŠ å‡é”®ï¼Œç›´è‡³å‡ºç°æç¤º</p>
            <p><strong>æˆ–ï¼š </strong>ä½¿ç”¨ä¸‹æ–¹ä¸€é”®æŠ“åŒ…æŒ‰é’®ï¼Œæ‰‹åŠ¨è¾“å…¥*å¼€å§‹æŠ“åŒ…</p>
            <p><strong>æ­¥éª¤ 2ï¼š</strong> ç¨ç­‰ç‰‡åˆ»åï¼Œå°†ç³»ç»Ÿå¯¼å‡ºçš„è¯Šæ–­æ–‡ä»¶ä¸Šä¼ è‡³æœ¬å·¥å…·</p>
            <p><strong>æœ¬å·¥å…·å°†è‡ªåŠ¨è®¡ç®—</strong></p>
            <!--
            <p><strong>æ­¥éª¤ 3ï¼š</strong> è¾“å…¥æ‚¨çš„HyperOS/MIUIè®¾å¤‡çš„åˆå§‹ç”µæ± å®¹é‡</p>
            <p><strong>æ­¥éª¤ 4ï¼š</strong> ç‚¹å‡»"è®¡ç®—"æŒ‰é’®ï¼Œè·å–å½“å‰ç”µæ± å®¹é‡çš„ç™¾åˆ†æ¯”</p>
            -->
            <iframe
                src="//player.bilibili.com/player.html?isOutside=true&aid=114260860472968&bvid=BV13YZ4YEE8B&cid=29177544707&p=1"
                scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"
                width="100%"></iframe>
        </div>

        <div class="file-upload">
            <label for="zip-file">é€‰æ‹©è¯Šæ–­æ–‡ä»¶:</label>
            <input type="file" id="zip-file" accept=".zip" required>
        </div>

        <!-- æ‰‹åŠ¨è¾“å…¥æ¡† -->
        <div id="manual-input-container" class="input-group">
            <label for="initial-capacity">è¯·è¾“å…¥æ‚¨çš„HyperOS/MIUIè®¾å¤‡çš„åˆå§‹ç”µæ± å®¹é‡ (mAh):</label>
            <input type="number" id="initial-capacity" placeholder="ä¾‹å¦‚: 5000" required>
        </div>

        <a href="tel:*%23*%23284%23*%23" target="_top" style="text-decoration: none;">
            <button
                style="background-color: #3498db; margin-bottom: 10px; width: 100%; padding: 12px; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 16px; font-weight: bold;">
                ğŸ”§ ä¸€é”®æŠ“åŒ…
            </button>
        </a>
        <p style="color:red;">(æ‹¨å·ç•Œé¢ä¸­è¾“å…¥" * "ä»¥å¼€å§‹æŠ“åŒ…)</p>

        <button id="calculate-btn">è®¡ç®—</button>

        <div id="status" class="status"></div>
        <div id="result" class="result"></div>
    </div>

    <div class="footer">
        <p>è§‰å¾—å¥½ç”¨ç‚¹é“¾æ¥æ”¯æŒä¸‹å‘—ï½<a href="http://119.29.227.6/pay">ã€é“¾æ¥ã€‘</a></p>
        <div class="open-source-links">
            <a href="https://github.com/gildas-lormeau/zip.js">å¼€æºå·¥å…·è®¸å¯</a>
            <span>|</span>
            <a href="https://github.com/Hikimucheno/HyperBatteryHealthCalc">æ­¤é¡¹ç›®å¼€æºåœ°å€</a>
        </div>
        <p>Copyright Â© HikiMuæ…•é±¼é…± All rights reserved. | å°ç±³ç”µæ± å®¹é‡è®¡ç®—å™¨</p>
    </div>


    <script>
        let autoExtractedInfo = {
            designCapacity: null,
            deviceModel: null,
            deviceName: null,
            reportTime: null,
            cycleCount: null,
            fullCapacity: null,
            estimatedCapacity: null,
            lastLearnedCapacity: null,
            minLearnedCapacity: null,
            maxLearnedCapacity: null
        };

        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('calculate-btn').addEventListener('click', calculateBatteryCapacity);
            document.getElementById('zip-file').addEventListener('change', handleFileSelect);
        });

        function handleFileSelect() {
            autoExtractedInfo = {
                designCapacity: null,
                deviceModel: null,
                deviceName: null,
                reportTime: null,
                cycleCount: null,
                fullCapacity: null,
                estimatedCapacity: null,
                lastLearnedCapacity: null,
                minLearnedCapacity: null,
                maxLearnedCapacity: null
            };

            document.getElementById('manual-input-container').style.display = 'none';
            document.getElementById('calculate-btn').style.display = 'none';

            document.getElementById('result').style.display = 'none';
            document.getElementById('status').style.display = 'none';

            // å°è¯•æå–è®¾å¤‡ä¿¡æ¯å¹¶åˆ†æ
            const file = document.getElementById('zip-file').files[0];
            if (file) {
                showStatus("æ­£åœ¨è‡ªåŠ¨åˆ†æç”µæ± æ•°æ®ï¼Œè¯·ç¨å€™...");
                extractDeviceInfo(file);
            }
        }

        // æå–è®¾å¤‡ä¿¡æ¯å¹¶åˆ†æ
        async function extractDeviceInfo(file) {
            try {
                const reader = new zip.ZipReader(new zip.BlobReader(file));
                const entries = await reader.getEntries();

                for (const entry of entries) {
                    if (entry.filename.endsWith('.zip')) {
                        const innerZipBlob = await entry.getData(new zip.BlobWriter('application/zip'));
                        const innerReader = new zip.ZipReader(new zip.BlobReader(innerZipBlob));
                        const innerEntries = await innerReader.getEntries();

                        for (const innerEntry of innerEntries) {
                            // æŸ¥æ‰¾ battery health æ–‡ä»¶æ¥æå–è®¾è®¡å®¹é‡å’Œå¾ªç¯æ¬¡æ•°
                            if (innerEntry.filename.includes('android.hardware.health') && innerEntry.filename.endsWith('.txt')) {
                                const content = await innerEntry.getData(new zip.TextWriter());

                                // æå–è®¾è®¡å®¹é‡ (ä» Î¼Ah è½¬æ¢ä¸º mAh)
                                const designCapacityMatch = content.match(/batteryFullChargeDesignCapacityUah\s*[:=]\s*(\d+)/);
                                if (designCapacityMatch) {
                                    autoExtractedInfo.designCapacity = parseInt(designCapacityMatch[1]) / 1000; // è½¬æ¢ä¸º mAh
                                }

                                // æå–å¾ªç¯æ¬¡æ•°
                                const cycleCountMatch = content.match(/batteryCycleCount\s*[:=]\s*(\d+)/);
                                if (cycleCountMatch) {
                                    autoExtractedInfo.cycleCount = parseInt(cycleCountMatch[1]);
                                }
                                const fullCapacityMatch = content.match(/batteryFullCharge(Uah)?\s*[:=]\s*(\d+)/);
                                if (fullCapacityMatch) {
                                    autoExtractedInfo.fullCapacity = parseInt(fullCapacityMatch[2]) / 1000; // è½¬æ¢ä¸º mAh
                                }
                            }

                            if (innerEntry.filename.includes('bugreport') && innerEntry.filename.endsWith('.txt')) {
                                const content = await innerEntry.getData(new zip.TextWriter());

                                const deviceInfo = extractDeviceInfoFromText(content);
                                if (deviceInfo.marketName) {
                                    autoExtractedInfo.deviceName = deviceInfo.marketName;
                                    autoExtractedInfo.deviceModel = deviceInfo.marketName;
                                } else if (deviceInfo.model) {
                                    autoExtractedInfo.deviceName = deviceInfo.model;
                                    autoExtractedInfo.deviceModel = deviceInfo.model;
                                }

                                const extractedData = extractDataFromText(content);
                                if (extractedData.reportTime) {
                                    autoExtractedInfo.reportTime = extractedData.reportTime;
                                }

                                if (extractedData.statistics) {
                                    const stats = extractBatteryCapacityFromStatistics(extractedData.statistics);
                                    Object.assign(autoExtractedInfo, stats);
                                }
                            }
                        }
                        await innerReader.close();
                    }
                }
                await reader.close();

                // å¦‚æœæˆåŠŸæå–åˆ°è®¾å¤‡ä¿¡æ¯ï¼Œè‡ªåŠ¨è®¡ç®—
                if (autoExtractedInfo.designCapacity) {
                    processZipFile(file, autoExtractedInfo.designCapacity);
                } else {
                    // å¦‚æœè‡ªåŠ¨æå–å¤±è´¥ï¼Œæ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥æ¡†å’Œè®¡ç®—æŒ‰é’®
                    document.getElementById('manual-input-container').style.display = 'block';
                    document.getElementById('calculate-btn').style.display = 'block';
                    document.getElementById('status').style.display = 'none';
                }
            } catch (error) {
                console.error("æå–è®¾å¤‡ä¿¡æ¯æ—¶å‡ºé”™:", error);
                // å¦‚æœå‡ºé”™ï¼Œæ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥æ¡†å’Œè®¡ç®—æŒ‰é’®
                document.getElementById('manual-input-container').style.display = 'block';
                document.getElementById('calculate-btn').style.display = 'block';
                document.getElementById('status').style.display = 'none';
            }
        }

        // æå–è®¾å¤‡ä¿¡æ¯
        function extractDeviceInfoFromText(text) {
            const lines = text.split('\n');
            let deviceInfo = {
                marketName: null,
                model: null,
                device: null
            };

            for (const line of lines) {
                const marketNameMatch = line.match(/\[ro\.product\.marketname\]:\s*\[([^\]]+)\]/);
                if (marketNameMatch) {
                    deviceInfo.marketName = marketNameMatch[1].trim();
                    console.log("æ‰¾åˆ°è®¾å¤‡åç§°:", deviceInfo.marketName);
                    continue;
                }

                // ç²¾ç¡®åŒ¹é… model
                const modelMatch = line.match(/\[ro\.product\.model\]:\s*\[([^\]]+)\]/);
                if (modelMatch) {
                    deviceInfo.model = modelMatch[1].trim();
                    console.log("æ‰¾åˆ°è®¾å¤‡å‹å·:", deviceInfo.model);
                    continue;
                }

                // ç²¾ç¡®åŒ¹é… device
                const deviceMatch = line.match(/\[ro\.product\.device\]:\s*\[([^\]]+)\]/);
                if (deviceMatch) {
                    deviceInfo.device = deviceMatch[1].trim();
                    console.log("æ‰¾åˆ°è®¾å¤‡ä»£ç :", deviceInfo.device);
                    continue;
                }

                // å¦‚æœå·²ç»æ‰¾åˆ°æ‰€æœ‰ä¿¡æ¯ï¼Œæå‰é€€å‡º
                if (deviceInfo.marketName && deviceInfo.model && deviceInfo.device) {
                    break;
                }
            }

            return deviceInfo;
        }

        // ä»æ–‡æœ¬ä¸­æå–æ•°æ®
        function extractDataFromText(text) {
            const lines = text.split('\n');
            let reportTime = null;
            let device = {
                name: null,
                model: null,
                code: null
            };
            let statistics = null;

            const reportTimePattern = /== dumpstate:\s*(.+)/;

            let inStatisticsSection = false;
            let statisticsLines = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                // æå–æŠ¥å‘Šæ—¶é—´
                if (!reportTime) {
                    const match = line.match(reportTimePattern);
                    if (match) {
                        reportTime = match[1];
                        continue;
                    }
                }

                // æ›´ç²¾ç¡®çš„åŒ¹é…
                if (!device.name) {
                    // ç²¾ç¡®åŒ¹é… marketname
                    const marketNameMatch = line.match(/\[ro\.product\.marketname\]:\s*\[([^\]]+)\]/);
                    if (marketNameMatch) {
                        device.name = marketNameMatch[1];
                        continue;
                    }

                    // ç²¾ç¡®åŒ¹é… model
                    const modelMatch = line.match(/\[ro\.product\.model\]:\s*\[([^\]]+)\]/);
                    if (modelMatch) {
                        device.model = modelMatch[1];
                        if (!device.name) device.name = modelMatch[1];
                        continue;
                    }

                    // ç²¾ç¡®åŒ¹é… device
                    const deviceMatch = line.match(/\[ro\.product\.device\]:\s*\[([^\]]+)\]/);
                    if (deviceMatch) {
                        device.code = deviceMatch[1];
                        continue;
                    }
                }

                // æå–ç”µæ± ç»Ÿè®¡ä¿¡æ¯
                if (line.startsWith('Statistics since last charge:')) {
                    inStatisticsSection = true;
                    statisticsLines.push(line);
                } else if (inStatisticsSection) {
                    if (line === '') {
                        inStatisticsSection = false;
                        statistics = statisticsLines.join('\n');
                    } else {
                        statisticsLines.push(line);
                    }
                }
            }

            // å¦‚æœæ²¡æœ‰åœ¨å¾ªç¯ä¸­è®¾ç½® statisticsï¼Œä½† statisticsLines ä¸ä¸ºç©º
            if (inStatisticsSection && statisticsLines.length > 0) {
                statistics = statisticsLines.join('\n');
            }

            return {
                reportTime,
                device,
                statistics
            };
        }

        // ä»ç»Ÿè®¡ä¿¡æ¯ä¸­æå–ç”µæ± å®¹é‡
        function extractBatteryCapacityFromStatistics(statisticsText) {
            const result = {};
            const lines = statisticsText.split('\n');

            for (const line of lines) {
                // æå–ä¼°ç®—å®¹é‡
                const estimatedMatch = line.match(/Estimated battery capacity:\s*([\d.]+)\s*mAh/i);
                if (estimatedMatch) {
                    result.estimatedCapacity = parseFloat(estimatedMatch[1]);
                }

                // æå–ä¸Šæ¬¡å­¦ä¹ å®¹é‡
                const lastLearnedMatch = line.match(/Last learned battery capacity:\s*(\d+)\s*mAh/i);
                if (lastLearnedMatch) {
                    result.lastLearnedCapacity = parseInt(lastLearnedMatch[1]);
                }

                // æå–æœ€å°å­¦ä¹ å®¹é‡
                const minLearnedMatch = line.match(/Min learned battery capacity:\s*(\d+)\s*mAh/i);
                if (minLearnedMatch) {
                    result.minLearnedCapacity = parseInt(minLearnedMatch[1]);
                }

                // æå–æœ€å¤§å­¦ä¹ å®¹é‡
                const maxLearnedMatch = line.match(/Max learned battery capacity:\s*(\d+)\s*mAh/i);
                if (maxLearnedMatch) {
                    result.maxLearnedCapacity = parseInt(maxLearnedMatch[1]);
                }
            }

            return result;
        }

        // è®¡ç®—ç”µæ± å®¹é‡
        async function calculateBatteryCapacity() {
            const fileInput = document.getElementById('zip-file');
            const initialCapacityInput = document.getElementById('initial-capacity');
            const statusDiv = document.getElementById('status');
            const resultDiv = document.getElementById('result');

            if (!fileInput.files || fileInput.files.length === 0) {
                showError(resultDiv, "è¯·é€‰æ‹©ä¸€ä¸ªè¯Šæ–­æ–‡ä»¶");
                return;
            }

            const initialCapacity = parseFloat(initialCapacityInput.value);
            // å¦‚æœè‡ªåŠ¨æå–å¤±è´¥ï¼Œæ‰éªŒè¯æ‰‹åŠ¨è¾“å…¥
            if (!autoExtractedInfo.designCapacity && (isNaN(initialCapacity) || initialCapacity <= 0)) {
                showError(resultDiv, "è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„åˆå§‹ç”µæ± å®¹é‡");
                return;
            }

            const file = fileInput.files[0];
            showStatus("æ­£åœ¨è§£æç”µæ± æ•°æ®ï¼Œè¯·ç¨å€™...");
            processZipFile(file, initialCapacity);
        }

        // å¤„ç†æ–‡ä»¶
        async function processZipFile(file, initialCapacity) {
            const statusDiv = document.getElementById('status');
            const resultDiv = document.getElementById('result');

            try {
                const reader = new zip.ZipReader(new zip.BlobReader(file));
                showStatus("æ­£åœ¨è§£å‹å¤–å±‚æ–‡ä»¶...");
                const entries = await reader.getEntries();

                for (const entry of entries) {
                    if (entry.filename.endsWith('.zip')) {
                        showStatus("æ­£åœ¨è§£å‹å†…å±‚æ–‡ä»¶...");
                        const innerZipBlob = await entry.getData(new zip.BlobWriter('application/zip'));
                        const innerReader = new zip.ZipReader(new zip.BlobReader(innerZipBlob));
                        showStatus("æ­£åœ¨æŸ¥æ‰¾åŒ…å«ç”µæ± å®¹é‡ä¿¡æ¯çš„æ–‡ä»¶...");
                        const innerEntries = await innerReader.getEntries();

                        for (const innerEntry of innerEntries) {
                            if (innerEntry.filename.includes('bugreport') && innerEntry.filename.endsWith('.txt')) {
                                showStatus("æ­£åœ¨æå–ç”µæ± å®¹é‡ä¿¡æ¯...");
                                const content = await innerEntry.getData(new zip.TextWriter());
                                const extractedData = extractDataFromText(content);
                                const statistics = extractedData.statistics;

                                // æå–ç”µæ± å®¹é‡ä¿¡æ¯
                                const batteryInfo = {};
                                if (statistics) {
                                    const stats = extractBatteryCapacityFromStatistics(statistics);
                                    Object.assign(batteryInfo, stats);
                                }

                                // ä½¿ç”¨æœ€å°å­¦ä¹ å®¹é‡ä½œä¸ºå½“å‰å®¹é‡
                                const currentCapacity = batteryInfo.minLearnedCapacity || autoExtractedInfo.minLearnedCapacity;

                                if (currentCapacity !== null && currentCapacity !== undefined) {
                                    showStatus("æ­£åœ¨è®¡ç®—ç”µæ± å®¹é‡ç™¾åˆ†æ¯”...");

                                    // ä¼˜å…ˆä½¿ç”¨è‡ªåŠ¨æå–çš„è®¾è®¡å®¹é‡ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ç”¨æˆ·è¾“å…¥
                                    const finalInitialCapacity = autoExtractedInfo.designCapacity || initialCapacity;
                                    const percentage = (currentCapacity / finalInitialCapacity) * 100;
                                    const rating = getBatteryRating(percentage);

                                    // æ„å»ºè¯¦ç»†çš„ç»“æœä¿¡æ¯
                                    let resultMessage = `
                                <div class="result-header">
                                    <h3>ğŸ”‹ ç”µæ± å®¹é‡è¯¦ç»†æŠ¥å‘Š</h3>
                                </div>
                                <div class="result-content">
                                    <p><strong>ğŸ“Š åŸºæœ¬ä¿¡æ¯</strong></p>
                            `;

                                    // æ˜¾ç¤ºè®¾å¤‡å‹å·ï¼ˆå¦‚æœæå–åˆ°ï¼‰
                                    if (autoExtractedInfo.deviceName || autoExtractedInfo.deviceModel) {
                                        const deviceName = autoExtractedInfo.deviceName || autoExtractedInfo.deviceModel;
                                        resultMessage += `<p>è®¾å¤‡å‹å·: <strong>${deviceName}</strong></p>`;
                                    }

                                    // æ˜¾ç¤ºè¯Šæ–­æ—¶é—´ï¼ˆå¦‚æœæå–åˆ°ï¼‰
                                    if (autoExtractedInfo.reportTime) {
                                        resultMessage += `<p>è¯Šæ–­æ—¶é—´: <strong>${autoExtractedInfo.reportTime}</strong></p>`;
                                    }

                                    resultMessage += `
                                    <p>åŸå§‹è®¾è®¡å®¹é‡: <strong>${finalInitialCapacity} mAh</strong>
                                    ${autoExtractedInfo.designCapacity ? '<span style="color: green;">(è‡ªåŠ¨æ£€æµ‹)</span>' : '<span style="color: orange;">(æ‰‹åŠ¨è¾“å…¥)</span>'}</p>
                                    <p>å½“å‰å®é™…å®¹é‡: <strong>${currentCapacity} mAh</strong></p>
                                    <p>ç”µæ± å¥åº·åº¦: <strong>${percentage.toFixed(2)}%</strong> <span style="margin-left: 10px; font-size: 0.9em; color: ${getRatingColor(percentage)}">(${rating})</span></p>
                            `;

                                    resultMessage += `
                                <p><strong>ğŸ”§ ç”µæ± ç¡¬ä»¶ä¿¡æ¯</strong></p>
                            `;

                                    if (autoExtractedInfo.estimatedCapacity) {
                                        resultMessage += `<p>ä¼°ç®—æ»¡å……å®¹é‡: <strong>${autoExtractedInfo.estimatedCapacity} mAh</strong></p>`;
                                    }
                                    if (autoExtractedInfo.lastLearnedCapacity) {
                                        resultMessage += `<p>ä¸Šæ¬¡å­¦ä¹ å®¹é‡: <strong>${autoExtractedInfo.lastLearnedCapacity} mAh</strong></p>`;
                                    }
                                    if (autoExtractedInfo.minLearnedCapacity) {
                                        resultMessage += `<p>æœ€å°å­¦ä¹ å®¹é‡: <strong>${autoExtractedInfo.minLearnedCapacity} mAh</strong> </p>`;
                                    }
                                    if (autoExtractedInfo.maxLearnedCapacity) {
                                        resultMessage += `<p>æœ€å¤§å­¦ä¹ å®¹é‡: <strong>${autoExtractedInfo.maxLearnedCapacity} mAh</strong></p>`;
                                    }
                                    if (autoExtractedInfo.cycleCount) {
                                        resultMessage += `<p>å……ç”µå¾ªç¯æ¬¡æ•°: <strong>${autoExtractedInfo.cycleCount} æ¬¡</strong></p>`;
                                        resultMessage += `<p style="font-size: 0.9em; color: #666;">ğŸ’¡ æ»¡å……å®¹é‡ä¼šéšç€å¾ªç¯æ¬¡æ•°çš„å¢åŠ è€Œé€æ¸å‡å°‘</p>`;
                                    } else {
                                        resultMessage += `<p>å……ç”µå¾ªç¯æ¬¡æ•°: <strong>æœªæ£€æµ‹åˆ°</strong> (ä¸åŒæœºå‹æ•°æ®æœ‰å·®å¼‚)</p>`;
                                    }

                                    resultMessage += `
                                </div>
                                <div class="result-content">
                                    <p class="footer">ä¸ªäººå¼€å‘çš„å°å·¥å…·ï¼Œç”¨çš„äººå˜å¤šäº†ï¼Œæ¯æœˆ 50 å…ƒæœåŠ¡å™¨è´¹æœ‰ç‚¹æ‰›ä¸ä½äº†... è§‰å¾—å¥½ç”¨ç‚¹é“¾æ¥æ”¯æŒä¸‹å‘—ï½<a href="http://119.29.227.6/pay">ã€é“¾æ¥ã€‘</a></p>
                                </div>
                            `;

                                    // åŸæ–‡æ˜¾ç¤ºåŠŸèƒ½
                                    if (statistics) {
                                        const originalTextId = 'original-text-' + Date.now();
                                        const batteryTranslatedText = translateBatteryInfoOnly(statistics);

                                        resultMessage += `
                                    <div class="result-header">
                                        <button class="toggle-btn" onclick="toggleOriginalText(this)">ğŸ“– æ˜¾ç¤ºç”µæ± è¯¦ç»†ä¿¡æ¯</button>
                                        <div class="original-text" id="${originalTextId}">
                                            <div class="content-block">
                                                <div class="section-title">ğŸ” ç”µæ± å…³é”®ä¿¡æ¯ç¿»è¯‘</div>
                                                <div style="background: #f0f8ff; padding: 12px; border-radius: 6px; margin-top: 8px;">
                                                    ${batteryTranslatedText}
                                                </div>
                                            </div>
                                            <div class="content-block">
                                                <div class="section-title">ğŸ“„ åŸå§‹ç”µæ± æ•°æ®</div>
                                                <pre style="background: #f5f5f5; padding: 12px; border-radius: 6px; margin-top: 8px; max-height: 300px; overflow-y: auto;">${statistics}</pre>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                    }

                                    showResult(resultDiv, resultMessage, true);

                                    await reader.close();
                                    await innerReader.close();
                                    return;
                                }
                            }
                        }
                        await innerReader.close();
                    }
                }

                showError(resultDiv, "æ— æ³•ä»æ–‡ä»¶ä¸­æ‰¾åˆ°æˆ–æå–ç”µæ± å®¹é‡");
                await reader.close();
            } catch (error) {
                console.error("å¤„ç†æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯:", error);
                showError(resultDiv, "å¤„ç†æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®");
            } finally {
                setTimeout(() => {
                    document.getElementById('status').style.display = 'none';
                }, 1000);
            }
        }


        function translateBatteryInfoOnly(originalText) {
            const batteryTranslations = {
                // æ ¸å¿ƒç”µæ± å®¹é‡ä¿¡æ¯
                'Estimated battery capacity': 'ä¼°ç®—ç”µæ± å®¹é‡',
                'Last learned battery capacity': 'ä¸Šæ¬¡å­¦ä¹ ç”µæ± å®¹é‡',
                'Min learned battery capacity': 'æœ€å°å­¦ä¹ ç”µæ± å®¹é‡',
                'Max learned battery capacity': 'æœ€å¤§å­¦ä¹ ç”µæ± å®¹é‡',

                // ç³»ç»Ÿç”µæ± çŠ¶æ€
                'System starts': 'ç³»ç»Ÿå¯åŠ¨æ¬¡æ•°',
                'currently on battery': 'å½“å‰ä½¿ç”¨ç”µæ± ä¾›ç”µ',

                'Time on battery': 'ç”µæ± ä½¿ç”¨æ€»æ—¶é—´',
                'Charge time remaining': 'å‰©ä½™å……ç”µæ—¶é—´',

                // æ”¾ç”µç»Ÿè®¡
                'Discharge': 'æ€»æ”¾ç”µé‡',
                'Screen off discharge': 'æ¯å±æ”¾ç”µé‡',
                'Screen doze discharge': 'ä¼‘çœ æ”¾ç”µé‡',
                'Screen on discharge': 'äº®å±æ”¾ç”µé‡',
                'Device light doze discharge': 'è®¾å¤‡è½»åº¦ä¼‘çœ æ”¾ç”µ',
                'Device deep doze discharge': 'è®¾å¤‡æ·±åº¦ä¼‘çœ æ”¾ç”µ',

                // ç»Ÿè®¡æ ‡é¢˜
                'Statistics since last charge': 'è‡ªä¸Šæ¬¡å……ç”µä»¥æ¥çš„ç»Ÿè®¡'
            };

            let translatedText = originalText;

            translatedText = translatedText.replace(/(\d+\.?\d*\s*mAh)/g, '<span class="capacity-value">$1</span>');
            translatedText = translatedText.replace(/(\d+h\s*\d+m\s*\d+s)/g, '<span class="time-value">$1</span>');
            translatedText = translatedText.replace(/(\d{4}-\d{2}-\d{2}-\d{2}-\d{2}-\d{2})/g, '<span class="time-value">$1</span>');

            Object.keys(batteryTranslations).forEach(english => {
                const chinese = batteryTranslations[english];
                const regex = new RegExp(english, 'g');
                translatedText = translatedText.replace(regex, `<span class="battery-key">${english}</span>\n    (${chinese})`);
            });

            return translatedText;
        }

        function getRatingColor(percentage) {
            if (percentage > 100) return '#ff6b35';
            else if (percentage >= 90) return '#2ecc71';
            else if (percentage >= 80) return '#f39c12';
            else if (percentage >= 70) return '#e67e22';
            else return '#e74c3c';
        }

        function getBatteryRating(percentage) {
            if (percentage > 100) {
                return "ğŸ”‹ è¶…å‡ºè®¾è®¡å®¹é‡ï¼ˆå¯èƒ½ä¸ºå†—ä½™è®¾è®¡æˆ–ç¬¬ä¸‰æ–¹ç”µæ± ï¼‰";
            } else if (percentage >= 90) {
                return "âœ… æä½³çŠ¶æ€";
            } else if (percentage >= 80) {
                return "ğŸ‘ è‰¯å¥½çŠ¶æ€";
            } else if (percentage >= 70) {
                return "âš ï¸ æ­£å¸¸è¡°å‡";
            } else {
                return "âŒ å»ºè®®è€ƒè™‘æ›´æ¢ç”µæ± ";
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(element, message, isSuccess) {
            element.innerHTML = message;
            element.className = isSuccess ? 'result success' : 'result error';
            element.style.display = 'block';
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(element, message) {
            showResult(element, message, false);
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(message) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        // åˆ‡æ¢åŸæ–‡æ˜¾ç¤º
        function toggleOriginalText(button) {
            const originalTextDiv = button.nextElementSibling;
            if (originalTextDiv.style.display === 'block') {
                originalTextDiv.style.display = 'none';
                button.textContent = 'ğŸ“– æ˜¾ç¤ºç”µæ± è¯¦ç»†ä¿¡æ¯';
            } else {
                originalTextDiv.style.display = 'block';
                button.textContent = 'ğŸ“– éšè—ç”µæ± è¯¦ç»†ä¿¡æ¯';
            }
        }
    </script>
</body>

</html>
